<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="hu"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">menu</a> &gt; <a href="index.source.html" class="el_package">org.example.database</a> &gt; <span class="el_source">DatabaseService.java</span></div><h1>DatabaseService.java</h1><pre class="source lang-java linenums">package org.example.database;

import org.example.game.GameState;
import org.example.game.LeaderboardEntry;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.List;

/**
 * Provides services for interacting with the database.
 */
public class DatabaseService {
    /** Logger for this class. */
<span class="fc" id="L20">    private static final Logger LOGGER</span>
<span class="fc" id="L21">    = LoggerFactory.getLogger(DatabaseService.class);</span>
    /** Database connection instance. */
    private final DatabaseConnection dbConnection;
    /** SQL query for updating win count in the leaderboard. */
    private static final String WIN_UPDATE_SQL
    = &quot;UPDATE Leaderboard SET Wins = Wins + 1 WHERE PlayerName = ?&quot;;

    /**
     * Constructs a new DatabaseService
     * with the given database connection.
     *@param connection The database connection to use.
     */
<span class="fc" id="L33">    public DatabaseService(final DatabaseConnection connection) {</span>
<span class="fc" id="L34">        this.dbConnection = connection;</span>
<span class="fc" id="L35">    }</span>
    /**
    * Inserts a player's name into the PlayerNames table.
    * @param playerName The name of the player to insert.
    */
    public void insertPlayerName(final String playerName) {
<span class="nc" id="L41">        String sql</span>
        = &quot;INSERT INTO PlayerNames (PlayerName) VALUES (?)&quot;;

<span class="nc" id="L44">        try (Connection conn = dbConnection.getConnection();</span>
<span class="nc" id="L45">             PreparedStatement pstmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L46">             pstmt.setString(1, playerName);</span>
<span class="nc" id="L47">             pstmt.executeUpdate();</span>
<span class="nc" id="L48">             LOGGER.info(&quot;Player name '{}'&quot;</span>
                     +
                     &quot; inserted into PlayerNames table&quot;, playerName);
<span class="nc" id="L51">        } catch (SQLException e) {</span>
<span class="nc" id="L52">            LOGGER.error(&quot;Error inserting player name&quot;</span>
                    +
                    &quot; into PlayerNames table&quot;, e);
<span class="nc" id="L55">        }</span>
<span class="nc" id="L56">    }</span>

    /** Index for the player name in prepared statements. */
    private static final int PLAYER_NAME_INDEX = 1;
    /** Index for the map state in prepared statements. */
    private static final int MAP_STATE_INDEX = 2;
    /** Index for the hero's X position in prepared statements. */
    private static final int HERO_POS_X_INDEX = 3;
    /** Index for the hero's Y position in prepared statements. */
    private static final int HERO_POS_Y_INDEX = 4;
    /** Index for the hero's initial X position in prepared statements. */
    private static final int HERO_INIT_POS_X_INDEX = 5;
    /** Index for the hero's initial Y position in prepared statements. */
    private static final int HERO_INIT_POS_Y_INDEX = 6;
    /** Index for the arrow count in prepared statements. */
    private static final int ARROW_COUNT_INDEX = 7;
    /** Index for the step count in prepared statements. */
    private static final int STEP_COUNT_INDEX = 8;
    /** Index for the Wumpus killed count in prepared statements. */
    private static final int WUMPUS_KILLED_COUNT_INDEX = 9;
    /** Index for the has gold flag in prepared statements. */
    private static final int HAS_GOLD_INDEX = 10;
    /** Index for the timestamp in prepared statements. */
    private static final int TIMESTAMP_INDEX = 11;
    /**
    * Saves the current game state for a player.
     * Saves the current game state for a player.
     * @param playerName The name of the player.
     * @param mapState The current state of the map.
     * @param heroPosX The hero's current X position.
     * @param heroPosY The hero's current Y position.
     * @param heroInitialPosX The hero's initial X position.
     * @param heroInitialPosY The hero's initial Y position.
     * @param arrowCount The number of arrows the hero has.
     * @param stepCount The number of steps taken by the hero.
     * @param wumpusKilledCount The number of Wumpuses killed by the hero.
     * @param hasGold Whether the hero has the gold.
     */
    public void saveGameState(final String playerName,
                              final String mapState,
                              final int heroPosX,
                              final int heroPosY,
                              final int heroInitialPosX,
                              final int heroInitialPosY,
                              final int arrowCount,
                              final int stepCount,
                              final int wumpusKilledCount,
                              final boolean hasGold) {

<span class="nc" id="L105">        String sql = &quot;INSERT INTO GameState (PlayerName,&quot;</span>
                     +
                     &quot; MapState, HeroPositionX,&quot;
                     +
                     &quot;HeroPositionY, HeroInitialPositionX, &quot;
                     +
                     &quot;HeroInitialPositionY, ArrowCount,&quot;
                     +
                     &quot;StepCount, wumpusKilledCount, hasGold, Timestamp) VALUES&quot;
                     +
                     &quot; (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;;

<span class="nc" id="L117">        try (Connection conn = dbConnection.getConnection();</span>
<span class="nc" id="L118">             PreparedStatement pstmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L119">            pstmt.setString(PLAYER_NAME_INDEX, playerName);</span>
<span class="nc" id="L120">            pstmt.setString(MAP_STATE_INDEX, mapState);</span>
<span class="nc" id="L121">            pstmt.setInt(HERO_POS_X_INDEX, heroPosX);</span>
<span class="nc" id="L122">            pstmt.setInt(HERO_POS_Y_INDEX, heroPosY);</span>
<span class="nc" id="L123">            pstmt.setInt(HERO_INIT_POS_X_INDEX, heroInitialPosX);</span>
<span class="nc" id="L124">            pstmt.setInt(HERO_INIT_POS_Y_INDEX, heroInitialPosY);</span>
<span class="nc" id="L125">            pstmt.setInt(ARROW_COUNT_INDEX, arrowCount);</span>
<span class="nc" id="L126">            pstmt.setInt(STEP_COUNT_INDEX, stepCount);</span>
<span class="nc" id="L127">            pstmt.setInt(WUMPUS_KILLED_COUNT_INDEX, wumpusKilledCount);</span>
<span class="nc" id="L128">            pstmt.setBoolean(HAS_GOLD_INDEX, hasGold);</span>
<span class="nc" id="L129">            pstmt.setTimestamp(TIMESTAMP_INDEX,</span>
<span class="nc" id="L130">                    new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L131">            pstmt.executeUpdate();</span>
<span class="nc" id="L132">            LOGGER.info(&quot;Game state saved for player '{}'. Step count: {},&quot;</span>
                    +
                    &quot; Wumpus killed: {}, Has gold: {}&quot;, playerName,
<span class="nc" id="L135">                    stepCount, wumpusKilledCount, hasGold);</span>
<span class="nc" id="L136">        } catch (SQLException e) {</span>
<span class="nc" id="L137">            LOGGER.error(&quot;Error saving game state for player '{}'&quot;,</span>
                    playerName, e);
<span class="nc" id="L139">        }</span>
<span class="nc" id="L140">    }</span>

    /**
     * Loads the game state for a given player.
     * @param playerName The name of the player
     * whose game state is to be loaded.
     * @return The loaded game state, or null if no state is found.
     */
    public GameState loadGameState(final String playerName) {
<span class="nc" id="L149">        String sql = &quot;SELECT * FROM GameState WHERE PlayerName = ?&quot;;</span>
<span class="nc" id="L150">        try (Connection conn = dbConnection.getConnection();</span>
<span class="nc" id="L151">             PreparedStatement pstmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L152">            pstmt.setString(1, playerName);</span>
<span class="nc" id="L153">            ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L155">                String mapState = rs.getString(&quot;MapState&quot;);</span>
<span class="nc" id="L156">                int heroPosX = rs.getInt(&quot;HeroPositionX&quot;);</span>
<span class="nc" id="L157">                int heroPosY = rs.getInt(&quot;HeroPositionY&quot;);</span>
<span class="nc" id="L158">                int heroInitialPosX = rs.getInt(&quot;HeroInitialPositionX&quot;);</span>
<span class="nc" id="L159">                int heroInitialPosY = rs.getInt(&quot;HeroInitialPositionY&quot;);</span>
<span class="nc" id="L160">                int arrowCount = rs.getInt(&quot;ArrowCount&quot;);</span>
<span class="nc" id="L161">                int stepCount = rs.getInt(&quot;StepCount&quot;);</span>
<span class="nc" id="L162">                int wumpusKilledCount = rs.getInt(&quot;wumpusKilledCount&quot;);</span>
<span class="nc" id="L163">                boolean hasGold = rs.getBoolean(&quot;hasGold&quot;);</span>
<span class="nc" id="L164">                LOGGER.info(&quot;Game state loaded successfully for player '{}'&quot;,</span>
                        playerName);
<span class="nc" id="L166">                return new GameState(playerName, mapState, heroPosX, heroPosY,</span>
                heroInitialPosX, heroInitialPosY, arrowCount, stepCount,
                wumpusKilledCount, hasGold);
            } else {
<span class="nc" id="L170">                LOGGER.info(&quot;No game state found for player '{}'&quot;,</span>
                        playerName);
            }
<span class="nc bnc" id="L173" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L174">            LOGGER.error(&quot;Error loading game state for player '{}'&quot;,</span>
                    playerName, e);
<span class="nc" id="L176">        }</span>
<span class="nc" id="L177">        return null;</span>
    }
    /**
     * Inserts or updates a player's entry in the leaderboard.
     * @param playerName The name of the player.
     * @param steps The number of steps taken by the player.
     * @param hasWon Whether the player has won the game.
     */
    public void insertOrUpdateLeaderboard(
            final String playerName,
            final int steps,
            final boolean hasWon) {

<span class="fc" id="L190">        String checkSql = &quot;SELECT Steps FROM Leaderboard&quot;</span>
                +
                &quot; WHERE PlayerName = ?&quot;;
<span class="fc" id="L193">        String insertSql = &quot;INSERT INTO Leaderboard &quot;</span>
                +
                &quot;(PlayerName, Steps, Wins) VALUES (?, ?, ?)&quot;;
<span class="fc" id="L196">        String updateSql = &quot;UPDATE Leaderboard SET Steps = ? &quot;</span>
                +
                &quot;WHERE PlayerName = ? AND ? &lt; Steps&quot;;
<span class="fc" id="L199">        boolean shouldUpdateWins = false;</span>

<span class="fc" id="L201">        try (Connection conn = dbConnection.getConnection();</span>
<span class="fc" id="L202">             PreparedStatement checkStmt = conn.prepareStatement(checkSql)) {</span>

<span class="fc" id="L204">            checkStmt.setString(1, playerName);</span>
<span class="fc" id="L205">            ResultSet rs = checkStmt.executeQuery();</span>

<span class="pc bpc" id="L207" title="1 of 2 branches missed.">            if (rs.next()) {</span>
<span class="fc" id="L208">                int existingSteps = rs.getInt(&quot;Steps&quot;);</span>
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">                if (steps &lt; existingSteps) {</span>
<span class="nc" id="L210">                    try (PreparedStatement updateStmt =</span>
<span class="nc" id="L211">                                 conn.prepareStatement(updateSql)) {</span>
<span class="nc" id="L212">                        updateStmt.setInt(1, steps);</span>
<span class="nc" id="L213">                        updateStmt.setString(2, playerName);</span>
<span class="nc" id="L214">                        updateStmt.setInt(3, steps);</span>
<span class="nc" id="L215">                        updateStmt.executeUpdate();</span>
<span class="nc" id="L216">                        LOGGER.info(&quot;Leaderboard updated for player '{}':&quot;</span>
                                +
<span class="nc" id="L218">                                &quot; new steps count is {}&quot;, playerName, steps);</span>
<span class="nc" id="L219">                        shouldUpdateWins = true;</span>
                    }
                } else {
<span class="fc" id="L222">                    LOGGER.info(&quot;No update required for player '{}'&quot;</span>
                                    +
                            &quot; on leaderboard: existing steps count is lower&quot;,
                            playerName);
                }
<span class="fc" id="L227">            } else {</span>
<span class="nc" id="L228">                try (PreparedStatement insertStmt =</span>
<span class="nc" id="L229">                             conn.prepareStatement(insertSql)) {</span>
<span class="nc" id="L230">                    insertStmt.setString(1, playerName);</span>
<span class="nc" id="L231">                    insertStmt.setInt(2, steps);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">                    insertStmt.setInt(3, hasWon ? 1 : 0);</span>
<span class="nc" id="L233">                    insertStmt.executeUpdate();</span>
<span class="nc" id="L234">                    LOGGER.info(&quot;New leaderboard entry created for player '{}':&quot;</span>
                                    +
                            &quot; steps count is {}, wins: {}&quot;,
<span class="nc bnc" id="L237" title="All 2 branches missed.">                            playerName, steps, hasWon ? 1 : 0);</span>
                }
            }
<span class="pc bpc" id="L240" title="2 of 4 branches missed.">            if (hasWon &amp;&amp; shouldUpdateWins) {</span>
<span class="nc" id="L241">                try (PreparedStatement winUpdateStmt =</span>
<span class="nc" id="L242">                             conn.prepareStatement(WIN_UPDATE_SQL)) {</span>
<span class="nc" id="L243">                    winUpdateStmt.setString(1, playerName);</span>
<span class="nc" id="L244">                    winUpdateStmt.executeUpdate();</span>
<span class="nc" id="L245">                    LOGGER.info(&quot;Incremented win count for player '{}'&quot;,</span>
                            playerName);
                }
            }
<span class="nc" id="L249">        } catch (SQLException e) {</span>
<span class="nc" id="L250">            LOGGER.error(&quot;Error updating or inserting leaderboard&quot;</span>
                    +
                    &quot; for player '{}'&quot;, playerName, e);
<span class="fc" id="L253">        }</span>
<span class="fc" id="L254">    }</span>
    /**
     * Retrieves the leaderboard from the database.
     * @return A list of LeaderboardEntry
     * objects representing the leaderboard in the menu.
     */
    public List&lt;LeaderboardEntry&gt; getLeaderboard() {
<span class="nc" id="L261">        List&lt;LeaderboardEntry&gt; leaderboard = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L262">        String sql = &quot;SELECT PlayerName, Steps, Wins&quot;</span>
                +
                &quot; FROM Leaderboard ORDER BY Wins DESC, Steps ASC&quot;;
<span class="nc" id="L265">        try (Connection conn = dbConnection.getConnection();</span>
<span class="nc" id="L266">             PreparedStatement pstmt = conn.prepareStatement(sql);</span>
<span class="nc" id="L267">             ResultSet rs = pstmt.executeQuery()) {</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L269">                String playerName = rs.getString(&quot;PlayerName&quot;);</span>
<span class="nc" id="L270">                int steps = rs.getInt(&quot;Steps&quot;);</span>
<span class="nc" id="L271">                int wins = rs.getInt(&quot;Wins&quot;);</span>
<span class="nc" id="L272">                leaderboard.add(new LeaderboardEntry(playerName, steps, wins));</span>
<span class="nc" id="L273">            }</span>
<span class="nc" id="L274">            LOGGER.info(&quot;Leaderboard retrieved successfully&quot;);</span>
<span class="nc" id="L275">        } catch (SQLException e) {</span>
<span class="nc" id="L276">            LOGGER.error(&quot;Error retrieving leaderboard&quot;, e);</span>
<span class="nc" id="L277">        }</span>
<span class="nc" id="L278">        return leaderboard;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>