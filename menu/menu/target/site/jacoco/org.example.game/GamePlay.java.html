<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="hu"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GamePlay.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">menu</a> &gt; <a href="index.source.html" class="el_package">org.example.game</a> &gt; <span class="el_source">GamePlay.java</span></div><h1>GamePlay.java</h1><pre class="source lang-java linenums">package org.example.game;

import org.example.database.DatabaseConnection;
import org.example.database.DatabaseService;
import org.example.map.MapID;
import org.example.map.MapReader;
import org.example.map.WayType;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * GamePlay class to manage the gameplay mechanics.
 */
public class GamePlay {
    /** The hero character in the game. */
    private Hero hero;
    /** The name of the player. */
    private String playerName;
    /** The size of the game map. */
    private int mapSize;
    /** Reader to read and manage the game map. */
    private MapReader mapReader;
    /** Flag to indicate if the game is over. */
<span class="fc" id="L24">    private boolean gameOver = false;</span>
    /** Count of steps taken by the player. */
<span class="fc" id="L26">    private int stepsCount = 0;</span>
    /** Count of Wumpuses killed in the game. */
    private int wumpusKilledCount;
    /** Flag to indicate if the game is won. */
<span class="fc" id="L30">    private boolean gameWon = false;</span>
    /** Initial position of the hero on the map. */
    private MapID heroInitialPosition;
    /** Logger for logging game events and information. */
<span class="fc" id="L34">    private static final Logger LOGGER =</span>
<span class="fc" id="L35">            LoggerFactory.getLogger(GamePlay.class);</span>

    /**
     * Initializes the gameplay with the specified parameters.
     * @param knight The knight character in the game.
     * @param mapLoader The reader to read and manage the game map.
     * @param initialStepCount Initial count of steps.
     * @param initialWumpusCount Initial count of Wumpuses killed.
     * @param playername The name of the player.
     */
    public GamePlay(
           final Hero knight,
           final MapReader mapLoader,
           final int initialStepCount,
           final int initialWumpusCount,
<span class="fc" id="L50">           final String playername) {</span>

<span class="fc" id="L52">        this.hero = knight;</span>
<span class="fc" id="L53">        this.playerName = playername;</span>
<span class="fc" id="L54">        this.stepsCount = initialStepCount;</span>
<span class="fc" id="L55">        this.wumpusKilledCount = initialWumpusCount;</span>

<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        if (mapLoader == null) {</span>
<span class="nc" id="L58">            this.mapReader = new MapReader();</span>
<span class="nc" id="L59">            this.mapReader.readMapFromFile();</span>
        } else {
<span class="fc" id="L61">            this.mapReader = mapLoader;</span>
        }
<span class="fc" id="L63">        this.mapSize = mapLoader.getMapSize();</span>
<span class="fc" id="L64">        LOGGER.info(&quot;GamePlay initialized for player: {}&quot;,</span>
                playername);

<span class="fc" id="L67">        MapID heroinitialposition = mapLoader.getHeroInitialPosition();</span>
<span class="fc" id="L68">        this.heroInitialPosition = mapLoader.getHeroInitialPosition();</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">        if (heroinitialposition != null) {</span>
<span class="fc" id="L70">            this.hero.setMapID(heroinitialposition);</span>
        }
<span class="fc" id="L72">    }</span>
    /**
     * Sets the initial position of the hero on the map.
     * @param newheroInitialPosition The new initial position
     * to be set for the hero.
     */
    public void setHeroInitialPosition(final MapID newheroInitialPosition) {
<span class="nc" id="L79">        this.heroInitialPosition = newheroInitialPosition;</span>
<span class="nc" id="L80">    }</span>
    /**
     * Changes the direction in which the hero is facing.
     * @param newDirection The new direction for the hero to face.
     */
    public void changeHeroDirection(final WayType newDirection) {
<span class="fc" id="L86">        hero.setWay(newDirection);</span>
<span class="fc" id="L87">        System.out.println(&quot;You are now looking &quot; + newDirection);</span>
<span class="fc" id="L88">    }</span>

    /**
     * Retrieves the current step count of the game.
     * @return The number of steps taken by the player so far.
     */
    public int getStepCount() {
<span class="nc" id="L95">        return stepsCount;</span>
    }

    /**
     * Checks if the player has won the game.
     * A player wins the game if they have collected
     * the gold and returned it to the starting position.
     * @return true if the player has won the game, false otherwise.
     */
    public boolean hasWon() {
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (hero.isHasGold()) {</span>
<span class="fc" id="L106">            MapID currentPos = hero.getMapID();</span>
<span class="fc" id="L107">            MapID initialPos = this.heroInitialPosition;</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">            if (currentPos.getHorizontal() == initialPos.getHorizontal()</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">                    &amp;&amp; currentPos.getVertical() == initialPos.getVertical()) {</span>
<span class="fc" id="L110">                System.out.println(&quot;\nCongratulations! You are clever!&quot;</span>
                        +
                        &quot; You have successfully returned the gold&quot;
                        +
                        &quot; to the starting&quot;
                        +
                        &quot; position in &quot; + stepsCount + &quot; steps. YOU WON!\n&quot;);
<span class="fc" id="L117">                gameWon = true;</span>
<span class="fc" id="L118">                LOGGER.info(&quot;Player '{}' has won the game in {} steps&quot;,</span>
<span class="fc" id="L119">                        playerName, stepsCount);</span>

<span class="fc" id="L121">                DatabaseService dbService =</span>
                        new DatabaseService(new DatabaseConnection());
<span class="fc" id="L123">                dbService.insertOrUpdateLeaderboard(this.playerName,</span>
                        stepsCount, true);

<span class="fc" id="L126">                LeaderBoard leaderboard = new LeaderBoard(dbService);</span>
<span class="fc" id="L127">                leaderboard.updateLeaderboard(this.playerName,</span>
                        stepsCount, true);
<span class="fc" id="L129">                return true;</span>
            }
        }
<span class="nc" id="L132">        return false;</span>
    }

    /**
     * Checks if the game has been won.
     * @return true if the game is won, false otherwise.
     */
    public boolean isGameWon() {
<span class="nc" id="L140">        return gameWon;</span>
    }

    /**
     * Moves the hero based on their current direction.
     * This method updates the hero's position on the map
     * .If the hero encounters a Wumpus or a wall,
     * the game ends or the move is blocked, respectively.
     * If the hero steps on a Pit, they lose an arrow.
     * The method also checks if the hero has won the game
     * by returning the gold to the starting position.
     */
    public void moveHero() {
<span class="fc" id="L153">        MapID currentMapID = hero.getMapID();</span>
<span class="fc" id="L154">        int horizontal = currentMapID.getHorizontal();</span>
<span class="fc" id="L155">        int vertical = currentMapID.getVertical();</span>


<span class="pc bpc" id="L158" title="4 of 5 branches missed.">        switch (hero.getWay()) {</span>
            case NORTH:
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">                if (vertical &gt; 1) {</span>
<span class="fc" id="L161">                    vertical--;</span>
                }
                break;
            case EAST:
<span class="nc bnc" id="L165" title="All 2 branches missed.">                if (horizontal &lt; mapSize) {</span>
<span class="nc" id="L166">                    horizontal++;</span>
                }
                break;
            case SOUTH:
<span class="nc bnc" id="L170" title="All 2 branches missed.">                if (vertical &lt; mapSize) {</span>
<span class="nc" id="L171">                    vertical++;</span>
                }
                break;
            case WEST:
<span class="nc bnc" id="L175" title="All 2 branches missed.">                if (horizontal &gt; 1) {</span>
<span class="nc" id="L176">                    horizontal--;</span>
                }
                break;
            default:
                break;
        }

<span class="fc" id="L183">        char targetChar = mapReader.getMapLines().get(vertical - 1)</span>
<span class="fc" id="L184">                .charAt(horizontal - 1);</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        if (targetChar == 'U') {</span>
<span class="nc" id="L186">            System.out.println(&quot;\nYou stepped on a Wumpus! GAME OVER.\n&quot;);</span>
<span class="nc" id="L187">            gameOver = true;</span>
<span class="nc" id="L188">            return;</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">        } else if (targetChar == 'W') {</span>
<span class="nc" id="L190">                System.out.println(&quot;\nCannot move onto a wall!\n&quot;);</span>
<span class="nc" id="L191">            return;</span>
        } else {
<span class="fc" id="L193">                hero.setMapID(new MapID(horizontal, vertical));</span>
<span class="fc" id="L194">                System.out.println(&quot;Hero's new position - Column:&quot;</span>
                        +
                        &quot; &quot; + horizontal + &quot;, Row: &quot; + vertical);
            }

<span class="fc" id="L199">        if (mapReader.getMapLines().get(vertical - 1)</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">                .charAt(horizontal - 1) == 'P') {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (hero.getArrowCount() &gt; 0) {</span>
<span class="nc" id="L202">                hero.setArrowCount(hero.getArrowCount() - 1);</span>
<span class="nc" id="L203">                System.out.println(&quot;You stepped on a Pit! Lost an arrow.&quot;</span>
                        +
<span class="nc" id="L205">                        &quot;Remaining arrows: &quot; + hero.getArrowCount());</span>
            }
        }
<span class="fc" id="L208">        hero.setMapID(new MapID(horizontal, vertical));</span>


<span class="pc bpc" id="L211" title="1 of 4 branches missed.">        if (hero.isHasGold() &amp;&amp; hero.getMapID().equals(</span>
                this.heroInitialPosition)) {
<span class="nc" id="L213">            hasWon();</span>
        }
<span class="fc" id="L215">        stepsCount++;</span>
<span class="fc" id="L216">    }</span>

    /**
     * Checks if the game is over.
     * @return true if the game is over, false otherwise.
     */
    public boolean isGameOver() {
<span class="nc" id="L223">        return gameOver;</span>
    }

    /**
     * Shoots an arrow in the current direction.
     * This method allows the hero to shoot an arrow
     * in their current direction. It checks if the arrow hits a Wumpus,
     * a wall, or if it is destroyed.
     * It updates the game state accordingly,
     * including the remaining arrow count and
     * the Wumpus kill count.
     */
    public void shootArrow() {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (hero.getArrowCount() &gt; 0) {</span>
<span class="nc" id="L237">            MapID currentMapID = hero.getMapID();</span>
<span class="nc" id="L238">            int horizontal = currentMapID.getHorizontal();</span>
<span class="nc" id="L239">            int vertical = currentMapID.getVertical();</span>

<span class="nc" id="L241">            boolean hitWall = false;</span>
<span class="nc" id="L242">            boolean hitWumpus = false;</span>
<span class="nc bnc" id="L243" title="All 4 branches missed.">            while (!hitWall &amp;&amp; !hitWumpus) {</span>
<span class="nc bnc" id="L244" title="All 5 branches missed.">                switch (hero.getWay()) {</span>
                    case NORTH:
<span class="nc bnc" id="L246" title="All 2 branches missed.">                        if (vertical &gt; 1) {</span>
<span class="nc" id="L247">                            vertical--;</span>
                        }
                        break;
                    case EAST:
<span class="nc bnc" id="L251" title="All 2 branches missed.">                        if (horizontal &lt; mapSize) {</span>
<span class="nc" id="L252">                            horizontal++;</span>
                        }
                        break;
                    case SOUTH:
<span class="nc bnc" id="L256" title="All 2 branches missed.">                        if (vertical &lt; mapSize) {</span>
<span class="nc" id="L257">                            vertical++;</span>
                        }
                        break;
                    case WEST:
<span class="nc bnc" id="L261" title="All 2 branches missed.">                        if (horizontal &gt; 1) {</span>
<span class="nc" id="L262">                            horizontal--;</span>
                        }
                        break;
                    default:
                        break;
                }
<span class="nc" id="L268">                char targetChar = mapReader.getMapLines().get(vertical - 1)</span>
<span class="nc" id="L269">                        .charAt(horizontal - 1);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                if (targetChar == 'W') {</span>
<span class="nc" id="L271">                    hitWall = true;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">                } else if (targetChar == 'U') {</span>
<span class="nc" id="L273">                    hitWumpus = true;</span>
<span class="nc" id="L274">                    mapReader.updateMapPosition(vertical - 1,</span>
                            horizontal - 1, '_');
                }
<span class="nc" id="L277">            }</span>

<span class="nc" id="L279">            hero.setArrowCount(hero.getArrowCount() - 1);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">            if (hitWumpus) {</span>
<span class="nc" id="L281">                wumpusKilledCount++;</span>
<span class="nc" id="L282">                System.out.println(&quot;SCREEEEEEEEEAM! You hit a Wumpus!&quot;</span>
                        +
<span class="nc" id="L284">                        &quot; Remaining arrows: &quot; + hero.getArrowCount());</span>
<span class="nc" id="L285">                LOGGER.info(&quot;Player '{}' hit a Wumpus at position - &quot;</span>
                        +
                        &quot;Column: {}, Row: {}&quot;,
<span class="nc" id="L288">                        playerName, horizontal, vertical);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">            } else if (hitWall) {</span>
<span class="nc" id="L290">                System.out.println(&quot;Arrow hit a wall and got destroyed.&quot;</span>
                        +
<span class="nc" id="L292">                        &quot; Remaining arrows: &quot; + hero.getArrowCount());</span>
<span class="nc" id="L293">                LOGGER.warn(&quot;Player '{}' arrow hit a wall at position&quot;</span>
                        +
                        &quot; - Column: {}, Row: {}&quot;,
<span class="nc" id="L296">                        playerName, horizontal, vertical);</span>
            } else {
<span class="nc" id="L298">                System.out.println(&quot;Shot an arrow towards &quot; + hero.getWay()</span>
                        +
<span class="nc" id="L300">                        &quot;. Remaining arrows: &quot; + hero.getArrowCount());</span>
            }
<span class="nc" id="L302">        } else {</span>
<span class="nc" id="L303">            System.out.println(&quot;No more arrows left.&quot;);</span>
        }
<span class="nc" id="L305">    }</span>

    /**
     * Allows the hero to pick up gold from their
     * current position on the map.
     * This method allows the hero to pick up gold if
     * it is present at their current position on the map. It updates
     * the game state, setting the hero's gold status to
     * true and updating the map to indicate the absence of gold
     * at that location.
     */
    public void pickUpGold() {
<span class="fc" id="L317">        MapID heroPosition = hero.getMapID();</span>
<span class="fc" id="L318">        int row = heroPosition.getVertical() - 1;</span>
<span class="fc" id="L319">        int column = heroPosition.getHorizontal() - 1;</span>

<span class="pc bpc" id="L321" title="1 of 2 branches missed.">        if (mapReader.getMapLines().get(row).charAt(column) == 'G') {</span>
<span class="nc" id="L322">            hero.setHasGold(true); // A hős felvette az aranyat</span>
<span class="nc" id="L323">            mapReader.updateMapPosition(row, column, '_');</span>
<span class="nc" id="L324">            System.out.println(&quot;You picked up the gold!&quot;);</span>
<span class="nc" id="L325">            LOGGER.info(&quot;Player '{}' picked up the gold at position&quot;</span>
                    +
<span class="nc" id="L327">                    &quot; - Column: {}, Row: {}&quot;, playerName, column + 1, row + 1);</span>
        } else {
<span class="fc" id="L329">            System.out.println(&quot;No gold here to pick up.&quot;);</span>
        }
<span class="fc" id="L331">    }</span>

    /**
     * Allows the hero to drop the gold they are
     * carrying at their current position on the map.
     * This method allows the hero to drop the gold
     * they are carrying at their current position on the map.
     * It updates the game state, setting the hero's
     * gold status to false and updating the map to indicate the
     * presence of gold at that location.
     */
    public void dropGold() {
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (hero.isHasGold()) {</span>
<span class="nc" id="L344">            MapID heroPosition = hero.getMapID();</span>
<span class="nc" id="L345">            int row = heroPosition.getVertical() - 1;</span>
<span class="nc" id="L346">            int column = heroPosition.getHorizontal() - 1;</span>

<span class="nc" id="L348">            hero.setHasGold(false);</span>
<span class="nc" id="L349">            mapReader.updateMapPosition(row, column, 'G');</span>
<span class="nc" id="L350">            System.out.println(&quot;You dropped the gold!&quot;);</span>
<span class="nc" id="L351">            LOGGER.info(&quot;Player '{}' dropped the gold at position&quot;</span>
                    +
<span class="nc" id="L353">                    &quot; - Column: {}, Row: {}&quot;, playerName, column + 1, row + 1);</span>
<span class="nc" id="L354">        } else {</span>
<span class="nc" id="L355">            System.out.println(&quot;You don't have any gold to drop.&quot;);</span>
        }
<span class="nc" id="L357">    }</span>

    /**
     * Returns the count of Wumpuses killed by the player.
     * @return The count of Wumpuses killed.
     */
    public int getWumpusKilledCount() {
<span class="nc" id="L364">        return wumpusKilledCount;</span>
    }

    /**
     * Returns the initial position of the hero on the map.
     * @return The initial position of the hero as a MapID object.
     */
    public MapID getHeroInitialPosition() {
<span class="nc" id="L372">        return heroInitialPosition;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>